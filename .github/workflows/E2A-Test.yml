name: E2A Test

on:
  workflow_dispatch:
    inputs:
      wipeAndReinstall:
        type: boolean
        description: 'Wipe & Re-Install E2A'

  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
    paths-ignore:
      - CODE_OF_CONDUCT.md
      - LICENSE
      - README.md
      - readme/**
      - dockerfiles/**
      - Notebooks/**
      - .github/workflows/stale.yml
      - .github/workflows/custom-command.yml

  push:
    branches:
      - main
    paths-ignore:
      - CODE_OF_CONDUCT.md
      - LICENSE
      - README.md
      - readme/**
      - dockerfiles/**
      - Notebooks/**
      - .github/workflows/stale.yml
      - .github/workflows/custom-command.yml

  release:
    types:
      - published

jobs:
  E2A-test:
    strategy:
      matrix:
        os: [macos, linux]
    runs-on: [self-hosted, "${{ matrix.os }}"]
    

    steps:
          
      - name: Print runner info
        shell: bash
        run: |
          echo "Running on:"
          uname -a
          if [[ "$OSTYPE" == "darwin"* ]]; then sw_vers; else cat /etc/os-release; fi

      - name: Wipe & Re-Install E2A
        if: ${{ inputs.wipeAndReinstall }}
        shell: bash
        run: rm -rf ~/ebook2audiobook

      - name: Clone ebook2audiobook (Universal Merge Logic)
              shell: bash
              run: |
                set -e
                REPO_DIR=~/ebook2audiobook
                REPO_URL="https://github.com/${{ github.repository }}"
                IS_PR="${{ github.event_name == 'pull_request' }}"
                
                # Variables for PR merging
                BASE_REF="${{ github.base_ref || github.ref_name }}" # usually 'main'
                PR_NUMBER="${{ github.event.pull_request.number }}"
                TRIGGER_SHA="${{ github.sha }}"
                FRESH_CLONE=0
            
                echo "==> Event: ${{ github.event_name }}"
                
                # 1. Setup or Clean Directory
                if [ -d "$REPO_DIR" ]; then
                  echo "==> Reusing existing repo"
                  cd "$REPO_DIR"
                  git remote set-url origin "$REPO_URL"
                  
                  # Fix shallow clones if necessary
                  if [ -f .git/shallow ]; then git fetch --unshallow; fi
                  
                  echo "==> Cleaning working directory"
                  git reset --hard
                  git clean -fd
                else
                  echo "==> Cloning fresh"
                  git clone "$REPO_URL" "$REPO_DIR"
                  cd "$REPO_DIR"
                  FRESH_CLONE=1
                fi
            
                # 2. Fetch and Checkout Logic
                echo "==> Fetching origin..."
                git fetch origin
                
                if [ "$IS_PR" = "true" ]; then
                  echo "==> PR detected (Number: $PR_NUMBER)"
                  echo "==> Simulating Merge: (PR #$PR_NUMBER) -> ($BASE_REF)"
                  
                  # Ensure we are on the latest version of the Target Branch (main)
                  git fetch origin "$BASE_REF"
                  git checkout -B "$BASE_REF" "origin/$BASE_REF"
                  
                  # Fetch the PR code specifically from GitHub's magic ref
                  echo "==> Fetching PR Head..."
                  git fetch origin "pull/$PR_NUMBER/head":pr_testing_branch
                  
                  echo "==> Attempting Merge..."
                  if ! git merge --no-ff --no-edit pr_testing_branch; then
                     echo "❌ Merge conflict detected!" 
                     echo "Attempting cleanup of common conflict sources (like __pycache__)..."
                     
                     # Remove untracked files that might block the merge
                     git clean -ffd lib/
                     
                     if ! git merge --no-ff --no-edit pr_testing_branch; then
                       echo "❌ FATAL: Could not merge PR. This PR has conflicts."
                       exit 1
                     fi
                  fi
                  echo "✅ Merge Successful. Testing the Combined Code."
                else
                  echo "==> Not a PR: checking out triggered commit directly"
                  git fetch origin "$TRIGGER_SHA"
                  git checkout --detach "$TRIGGER_SHA"
                fi
            
                # 3. Dependencies / Script Setup
                if [ "$FRESH_CLONE" -eq 1 ]; then
                  echo "==> Fresh clone detected, ensuring script is executable"
                  chmod +x ebook2audiobook.sh
                  if ! ./ebook2audiobook.sh --help; then
                    echo "==> Attempting fallback with conda deactivation"
                    source "$(conda info --base 2>/dev/null)/etc/profile.d/conda.sh" 2>/dev/null && conda deactivate || true
                    ./ebook2audiobook.sh --help
                  fi
                fi




      - name: Create Audiobook Output folders for Artifacts
        shell: bash
        run: |
          mkdir -p ~/ebook2audiobook/audiobooks/{TACOTRON2,FAIRSEQ,UnFAIRSEQ,VITS,YOURTTS,XTTSv2,XTTSv2FineTune,XTTSv2FineTuneCustom,BARK}
          find ~/ebook2audiobook/audiobooks/{TACOTRON2,FAIRSEQ,UnFAIRSEQ,VITS,YOURTTS,XTTSv2,XTTSv2FineTune,XTTSv2FineTuneCustom,BARK} -mindepth 1 -exec rm -rf {} +

      - name: Add set -e at beginning of ebook2audiobook.sh (for error passing)
        shell: bash
        run: |
          echo "Adding set -e at beginning of ebook2audiobook.sh (for error passing)..."
          cd ~/ebook2audiobook
          conda deactivate 2>/dev/null || true
          sed -i.bak '1s;^;set -e\n;' ebook2audiobook.sh && rm -f ebook2audiobook.sh.bak

      - name: English TACOTRON2 Custom-Voice headless single test
        shell: bash
        run: |
          echo "Running English TACOTRON2 Custom-Voice headless single test..."
          cd ~/ebook2audiobook
          conda deactivate 2>/dev/null || true
          ./ebook2audiobook.sh --headless  --language eng --ebook "tools/workflow-testing/test1.txt" --tts_engine TACOTRON2 --voice "voices/eng/elder/male/DavidAttenborough.wav" --output_dir ~/ebook2audiobook/audiobooks/TACOTRON2

      - name: English FAIRSEQ OCR headless single test
        shell: bash
        run: |
          echo "Running English FAIRSEQ OCR headless single test..."
          cd ~/ebook2audiobook
          conda deactivate 2>/dev/null || true
          ./ebook2audiobook.sh --headless  --language eng --ebook "tools/workflow-testing/ocr_eng_script_font.jpg" --tts_engine FAIRSEQ --output_dir ~/ebook2audiobook/audiobooks/FAIRSEQ

      - name: Haitian Creole FAIRSEQ OCR headless single test
        shell: bash
        run: |
          echo "Running Haitian Creole FAIRSEQ OCR headless single test..."
          cd ~/ebook2audiobook
          conda deactivate 2>/dev/null || true
          ./ebook2audiobook.sh --headless  --language hat --ebook "tools/workflow-testing/odc_test_haitian.pdf" --tts_engine FAIRSEQ --output_dir ~/ebook2audiobook/audiobooks/FAIRSEQ


      - name: English FAIRSEQ Custom-Voice headless single test
        shell: bash
        run: |
          echo "Running English FAIRSEQ Custom-Voice headless single test..."
          cd ~/ebook2audiobook
          conda deactivate 2>/dev/null || true
          ./ebook2audiobook.sh --headless  --language eng --ebook "tools/workflow-testing/test1.txt" --tts_engine FAIRSEQ --voice "voices/eng/elder/male/DavidAttenborough.wav" --output_dir ~/ebook2audiobook/audiobooks/FAIRSEQ

          
      - name: Unusual FAIRSEQ Custom-Voice headless single test
        shell: bash
        run: |
          echo "Running Unusual FAIRSEQ Custom-Voice headless single test..."
          cd ~/ebook2audiobook
          conda deactivate 2>/dev/null || true
          ./ebook2audiobook.sh --headless  --language urd-script_devanagari --ebook "tools/workflow-testing/urd-script_davanagari-test.txt" --tts_engine FAIRSEQ --voice "voices/eng/elder/male/DavidAttenborough.wav" --output_dir ~/ebook2audiobook/audiobooks/UnFAIRSEQ

      - name: English VITS Custom-Voice headless single test
        shell: bash
        run: |
          echo "Running English VITS Custom-Voice headless single test..."

          cd ~/ebook2audiobook
          conda deactivate 2>/dev/null || true
          ./ebook2audiobook.sh --headless  --language eng --ebook "tools/workflow-testing/test1.txt" --tts_engine VITS --voice "voices/eng/elder/male/DavidAttenborough.wav" --output_dir ~/ebook2audiobook/audiobooks/VITS

      - name: English YOURTTS Custom-Voice headless batch test
        shell: bash
        run: |
          echo "Running English YOURTTS Custom-Voice headless batch test..."
          cd ~/ebook2audiobook
          conda deactivate 2>/dev/null || true
          ./ebook2audiobook.sh --headless  --language eng --ebooks_dir "tools/workflow-testing" --tts_engine YOURTTS --voice "voices/eng/elder/male/DavidAttenborough.wav" --output_dir ~/ebook2audiobook/audiobooks/YOURTTS


      - name: Default XTTSv2 headless Custom-Voice single test
        shell: bash
        run: |
          echo "Running Default XTTSv2 headless Custom-Voice single test..."
          cd ~/ebook2audiobook
          conda deactivate 2>/dev/null || true
          ./ebook2audiobook.sh --headless  --language eng --ebook "tools/workflow-testing/test1.txt" --tts_engine XTTSv2 --voice "voices/eng/elder/male/DavidAttenborough.wav" --output_dir ~/ebook2audiobook/audiobooks/XTTSv2

      - name: English XTTSv2 headless fine-tuned XTTSv2 model single test
        shell: bash
        run: |
          echo "Running English XTTSv2 headless fine-tuned XTTSv2 model single test..."
          cd ~/ebook2audiobook
          conda deactivate 2>/dev/null || true
          ./ebook2audiobook.sh --headless  --language eng --ebook "tools/workflow-testing/test1.txt" --tts_engine XTTSv2 --fine_tuned AiExplained --output_dir ~/ebook2audiobook/audiobooks/XTTSv2FineTune

      - name: English XTTSv2 headless custom fine-tuned XTTSv2 model single test
        shell: bash
        run: |
          echo "English XTTSv2 headless custom fine-tuned XTTSv2 model single test..."
          cd ~/ebook2audiobook
          conda deactivate 2>/dev/null || true
          [ ! -f BadCartmanSouthPark.zip ] && curl -L "https://huggingface.co/drewThomasson/fineTunedTTSModels/resolve/main/xtts-v2/eng/BadCartmanSouthPark/BadCartmanSouthPark.zip" -o BadCartmanSouthPark.zip || echo "BadCartmanSouthPark.zip already exists"
          ./ebook2audiobook.sh --headless --language eng --ebook "tools/workflow-testing/test1.txt" --custom_model "BadCartmanSouthPark.zip" --tts_engine XTTSv2 --output_dir ~/ebook2audiobook/audiobooks/XTTSv2FineTuneCustom
          ls -lhR ./models/__sessions && rm -rf ./models/__sessions

      - name: English BARK Custom-Voice headless single test
        shell: bash
        run: |
          echo "Running English XTTSv2 headless fine-tuned XTTSv2 model single test..."
          cd ~/ebook2audiobook
          conda deactivate 2>/dev/null || true
          ./ebook2audiobook.sh --headless --language eng --ebook "tools/workflow-testing/test1.txt" --tts_engine BARK --voice "voices/eng/elder/male/DavidAttenborough.wav" --output_dir ~/ebook2audiobook/audiobooks/BARK 

      - name: Upload audiobooks folder artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audiobooks
          path: ~/ebook2audiobook/audiobooks
